<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Houston we have a bug - test page</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
      }
    </style>
  </head>
  <body>
    <!-- Use the full annotation component -->
    <hb-annotation id="test-annotation"></hb-annotation>

    <script type="module">
      // Load the built extension file
      import './tab.js';

      // Add error handling
      window.addEventListener('error', (e) => {
        console.error('Error loading:', e);
      });

      console.log('Waiting for hb-annotation to be defined...');

      // Wait for custom elements to be defined
      customElements
        .whenDefined('hb-annotation')
        .then(async () => {
          console.log('hb-annotation is defined!');
          const annotation = document.getElementById('test-annotation');
          console.log('Found annotation element:', annotation);

          // Wait for initial render
          await annotation.updateComplete;

          // Create a simple test image (white canvas with grid)
          const testCanvas = document.createElement('canvas');
          testCanvas.width = 800;
          testCanvas.height = 600;
          const ctx = testCanvas.getContext('2d');

          // White background
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, 800, 600);

          // Grid
          ctx.strokeStyle = '#e0e0e0';
          ctx.lineWidth = 1;
          for (let x = 0; x < 800; x += 50) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, 600);
            ctx.stroke();
          }
          for (let y = 0; y < 600; y += 50) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(800, y);
            ctx.stroke();
          }

          // Mock system info for testing
          const mockSystemInfo = {
            dateAndTime: '2026-01-18 12:00:00',
            url: 'http://localhost:8080/test-page.html',
            visibleArea: '1920 x 1080 px',
            displayResolution: '1920 x 1080 px',
            devicePixelRatio: '1',
            browser: 'Chrome 131',
            os: 'macOS',
          };

          console.log('Setting data URL and system info...');
          // Set private properties using bracket notation
          annotation['dataUrl'] = testCanvas.toDataURL();
          annotation['systemInfo'] = mockSystemInfo;

          // Force a re-render and wait for it
          await annotation.requestUpdate();
          await annotation.updateComplete;
          console.log('Data set and component updated!');
        })
        .catch((err) => {
          console.error('Error waiting for hb-annotation:', err);
        });
    </script>
  </body>
</html>
